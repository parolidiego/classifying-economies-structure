---
title: "Assignment I"
output: html_document
---

## Objective



## Load libraries

```{r}
rm(list = ls())
#install.packages("tidyverse")
#install.packages("DataExplorer")
#install.packages("mice")
library(tidyverse)
library(DataExplorer)
library(mice)
library(ggplot2)
library(RColorBrewer)
```

## Read the data

I have carefully handpicked variables that can help us characterize different economic structures from the World Development Indicators of the World Bank.

The dataset includes:

-   Value added of different sectors of the economy (in % of GDP)

-   Trade balance of the country (in % of GDP)

-   Trade openness (trade as % of GDP)

-   Central government debt (as a % of GDP) to capture public debt

-   Government consumption expenditure (as a % of GDP) to capture public spending

-   Unemployment (as a % of total labor force)

-   Youth unemployment (as a % of labor force 15-24)

-   Net ODA received (as a % of GNI) to capture reliance on foreign aid

-   Total natural resources rents (as a % of GDP) to capture reliance on natural resources

-   International tourism, receipts (as a % of total exports) to capture reliance on tourism

-   \% of exports ascribable to different sectors to capture reliance on particular type of exports

    -   ex. foods exports as a % of total merchandise exports

    -   ex. insurance and financial services as a % of total commercial service exports

-   Labor force participation rate, female (as a % of total female population ages 15-64) to capture the involvement of women in the economy

-   International migrant stock (% of population) as a proxy of the importance of the foreign population

-   Age dependency ratio (% of people older than 64 to the total working-age population) as a proxy of the problem of an aging population

I downloaded data for years 2015 to 2019 so that by averaging over those years I am able to reduce the number of missing values but still retain a significant representation of the economic structure of different countries in a fairly recent period.

```{r}
raw_data <- read_csv("WDI_data.csv", show_col_types = FALSE)
```

Data can also be obtained the following way, but we would need to subset just the countries, as by running `country = "all"` we obtain data for subnational geographical entities as well (ex. Africa Eastern and Southern)

```{r}
# indicators_list <- raw_data |>
#   distinct(`Series Code`) |> 
#   drop_na() |>
#   pull(`Series Code`) 
# library(WDI)
# df = WDI(country = "all", indicator = indicators_list, start = 2015, end = 2019) 
```

## Cleaning and pre-processing

```{r, warning=FALSE}
data <- raw_data |> 
  # Dropping code of the indicator
  select(- "Series Code") |> 
  # Converting columns to numeric
  mutate(across(contains("YR"), as.numeric)) |> 
  # Obtaining the mean value for the 2015 to 2019 period
  mutate(mean_value = rowMeans(across(contains("YR")), na.rm = TRUE)) |> 
  # Dropping captions in the dataset
  slice(1:5208) |> 
  # Dropping columns with single year data
  select(-contains("YR")) |> 
  # Correctly encode NaN as NA
  mutate(mean_value = ifelse(is.nan(mean_value), NA, mean_value)) |>
  # Pivoting wider
  pivot_wider(names_from = "Series Name", values_from = "mean_value")

# Modifying column names
colnames(data) <- c(
  "country_name",  
  "country_code",  
  "agriculture_%gdp",  
  "industry_%gdp",  
  "services_%gdp",  
  "trade_balance",  
  "trade_openess",  
  "public_debt",  
  "public_spending",  
  "unemployment_total",  
  "unemployment_youth",  
  "foreign_aid",  
  "natural_resources_rents",  
  "tourism_exports",  
  "agriculture_exports",  
  "food_exports",  
  "fuel_exports",  
  "manufactures_exports",  
  "ores_metals_exports",  
  "ict_services_exports",  
  "finance_services_exports",  
  "transport_services_exports",  
  "travel_services_exports",  
  "female_labor_participation",  
  "migrant_population",  
  "age_dependency"
)
str(data)
```

```{r}
# Check correlation
plot_correlation(data, type = "continuous", cor_args = list("use" = "pairwise.complete.obs"))
```

I confirm that the variables appear to be correlated at least to a certain extent and that therefore are appropriate for this assignment.

### Missing Data

```{r}
plot_intro(data)
plot_missing(data)
```

I have a worrying number of missing data especially for the variables public debt and foreign aid

But first let's check if there are some countries with a particularly high number of missing data

```{r}
# Constructing a dataset counting how many missing data each country has 
missing_counts <- data.frame(
  country_name = data$country_name,
  missing_count = rowSums(is.na(data[, -c(1, 2)]))
)

# Extracting the countries with at least 50% of missing data (12 out of 24 variables)
high_missing_countries <- missing_counts |> 
  filter(missing_count >= 12) |> 
  pull(country_name)
high_missing_countries
```

These countries are either small island countries or countries with a very close authoritarian regime or countries ravaged by wars. Therefore due to the high percentage of missing data and their peculiarity I decide to get rid of them.

```{r}
# Getting rid of them
reduced_df <- data |> 
  filter(!country_name %in% high_missing_countries)
```

I now investigate more into the high percentage of missingness for the variable `foreign_aid`

```{r}
# Extracting the list of countries that report NAs for foreign aid
reduced_df |> 
  filter(is.na(foreign_aid)) |> 
  pull(country_name)
```

All those countries are high-income countries (sometimes even donor countries) that do not receive official development assistance therefore we can safely recode the NAs of these countries into zeros.

```{r}
# Recoding foreign_aid NAs
reduced_df <- reduced_df |> 
  mutate(foreign_aid = ifelse(is.na(foreign_aid), 0, foreign_aid))
```

Finally I will now focus on the imputation of the missing values for all variables, even for the column `public_debt` that although has a really high  number of missing values I consider quite important.

```{r, message=FALSE, warning=FALSE, results='hide'}
# Dropping for the imputation country_code and country_name (identifier variables)
numeric <- reduced_df |> 
  select(-c("country_name", "country_code"))

# Imputing public_debt with several methods
imputed_public_debt <- data.frame(
  original = numeric$public_debt,
  imputed_pmm = complete(mice(numeric, m= 1, method = "pmm", seed=123))$public_debt,
  imputed_cart = complete(mice(numeric, m = 1, method = "cart", seed=123))$public_debt,
  imputed_rf = complete(mice(numeric, m = 1, method = "rf", seed=123))$public_debt,
  imputed_norm = complete(mice(numeric, m = 1, method = "norm", seed=123))$public_debt,
  imputed_norm.boot = complete(mice(numeric, m = 1, method = "norm.boot", seed=123))$public_debt,
  imputed_lasso.norm = complete(mice(numeric, m = 1, method = "lasso.norm", seed=123))$public_debt)

# Imputing tourism exports with several methods
imputed_tourism_exports <- data.frame(
  original = numeric$tourism_exports,
  imputed_pmm = complete(mice(numeric, m= 1, method = "pmm", seed=123))$tourism_exports,
  imputed_cart = complete(mice(numeric, m = 1, method = "cart", seed=123))$tourism_exports,
  imputed_rf = complete(mice(numeric, m = 1, method = "rf", seed=123))$tourism_exports,
  imputed_norm = complete(mice(numeric, m = 1, method = "norm", seed=123))$tourism_exports,
  imputed_norm.boot = complete(mice(numeric, m = 1, method = "norm.boot", seed=123))$tourism_exports,
  imputed_lasso.norm = complete(mice(numeric, m = 1, method = "lasso.norm", seed=123))$tourism_exports)
```

I will now plot the obtain distributions to understand which method best resembles the original distribution

```{r, warning=FALSE}
# Plotting public_debt

# Convert data to long format for plotting
imputed_long_public_debt <- imputed_public_debt |> 
  pivot_longer(cols = everything(), names_to = "Method", values_to = "Value")

# Define color palette
colors_fill <- c(brewer.pal(6, "Set1"), "black")

# Plot with faceting
ggplot(imputed_long_public_debt, aes(x = Value, , fill = Method)) +
  geom_histogram(bins = 15, alpha = 0.7, color = "black") +
  facet_wrap(~Method, scales = "free_y") +
  scale_fill_manual(values = colors_fill) + 
  labs(title = "Comparison of Original and Imputed Distributions for Public Debt variable",
       x = "Public Debt",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")



# Plotting tourism exports

imputed_long_tourism <- imputed_tourism_exports %>%
  pivot_longer(cols = everything(), names_to = "Method", values_to = "Value")

colors_fill <- c(brewer.pal(6, "Set1"), "black")

ggplot(imputed_long_tourism, aes(x = Value, fill = Method)) +
  geom_histogram(bins = 15, alpha = 0.7, color = "black") +
  facet_wrap(~Method, scales = "free_y") +
  scale_fill_manual(values = colors_fill) + 
  labs(title = "Comparison of Original and Imputed Distributions for Tourism Exports Variable",
       x = "Tourism Exports",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none") 
```


```{r}
######mc <- mice(reduced_df, m=1, method='rf', seed=123)
```


## Descriptive analysis

```{r}
explore::describe(reduced_df)
GGally::ggcorr(reduced_df)
```


```{r}
# Calculating NAs, min, median, mean and max by indicator
# data_summary <- data |> 
#   summarise(NA_count = sum(is.na(value)), 
#             min = round(min(value, na.rm = TRUE), 2), 
#             median = round(median(value, na.rm = TRUE), 2), 
#             mean = round(mean(value, na.rm = TRUE), 2), 
#             max = round(max(value, na.rm = TRUE), 2))
```


```{r, fig.height=25}
#explore::explore_tbl(reduced_df)

#mPlots distribution with the mean
reduced_df |> 
  select(- c("country_name", "country_code")) |> 
  explore::explore_all()
```

```{r, fig.height=35}
PerformanceAnalytics::chart.Correlation(reduced_df |> select(-c("country_name", "country_code")))
```

```{r, fig.height=10}
PerformanceAnalytics::chart.Boxplot(reduced_df |> select(-c("country_name", "country_code")))
```

